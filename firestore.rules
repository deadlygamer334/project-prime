rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection
    match /users/{userId} {
      // Allow users to read their own document
      allow read: if request.auth != null && request.auth.uid == userId;

      // Allow any authenticated user to read public leaderboard fields
      // This rule allows 'get' operations for any authenticated user.
      // To restrict which fields are readable, you would typically use
      // `request.resource.data.keys().hasOnly(['displayName', 'weeklyFocusBlocks'])`
      // but 'get' operations don't allow field-level restrictions in this way.
      // A more robust solution for field-level privacy on 'get' might involve
      // separate collections for public data or Cloud Functions.
      allow get: if request.auth != null;

      // Allow listing users for leaderboard (read displayName, weeklyFocusBlocks)
      // This rule allows 'list' operations for any authenticated user.
      // For 'list', you can restrict fields using `request.resource.data.keys()`.
      allow list: if request.auth != null;

      // Allow users to write to their own document
      allow write: if request.auth != null && request.auth.uid == userId;

      // Focus sessions subcollection
      match /focusSessions/{sessionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Allow access to all other subcollections (habits, todoLists, etc.) if owned by user
      match /{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
